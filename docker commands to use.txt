1. check network

docker network inspect survey-network >/dev/null 2>&1 || docker network create survey-network

2. build images

docker build -t abacws-api -f api/Dockerfile api
docker build -t abacws-visualiser -f visualiser/Dockerfile visualiser
docker build -t rasa-frontend -f rasa-frontend/Dockerfile ./rasa-frontend
docker build -t abacws-sender -f telemetry/Dockerfile .

3. Run containers

docker run -d --name abacws-survey-mongo --restart always -v ./Mongo/mongo-data:/data/db -p 27018:27017 --network survey-network --network-alias survey-mongo mongo

docker run -d --name abacws-api --hostname apihost --restart always -e API_PORT=5000 -e MONGO_URL=mongodb://survey-mongo:27017 -e MONGODB_URI=mongodb://survey-mongo:27017/abacws -e JWT_SECRET=change-this-jwt-secret-in-production-use-strong-random-string -e SESSION_SECRET=change-this-secret-in-production -e API_KEY=V3rySecur3Pas3word -p 5000:5000 -v ./api/src/api/data:/api/src/api/data --network survey-network --network-alias api --health-cmd='sh -lc "wget -qO- http://localhost:5000/health | grep -q '\''ok'\''"' --health-interval=30s --health-timeout=5s --health-retries=5 abacws-api

docker run -d --name abacws-visualiser --hostname visualiserhost --restart always -p 8090:80 -e WEB_PORT=80 -e API_HOST=api:5000 --network survey-network --network-alias visualiser --label "traefik.enable=true" --label "traefik.http.services.abacws-visualiser.loadbalancer.server.port=80" --label 'traefik.http.routers.abacws-visualiser.rule=Host(`visualiser.abacws.example.com`)' --label "traefik.http.routers.abacws-visualiser.entrypoints=https" --label "traefik.http.routers.abacws-visualiser.tls=true" --health-cmd='sh -lc "wget -qO- http://localhost/health | grep -q '\''ok'\''"' --health-interval=30s --health-timeout=10s --health-retries=5 abacws-visualiser

docker run -d --name rasa-frontend-bldg1 --hostname rasa-frontend-host-bldg1 --restart unless-stopped -p 3000:3000 -v ./rasa-frontend/:/app -v /app/node_modules -e NODE_ENV=development -e REACT_APP_API_URL=http://localhost:5000/api -e REACT_APP_VISUALIZER_URL=http://localhost:8090 --network survey-network rasa-frontend npm start

docker run -d --name abacws-sender --restart always -e API_BASE=http://api:5000/api -e INTERVAL_SECONDS=30 -e API_HEALTH=http://api:5000/health -e VIS_HEALTH=http://visualiser:80/health -p 8088:8088 --network survey-network --health-cmd='wget -qO- http://localhost:8088/health | grep ok' --health-interval=30s --health-timeout=5s --health-retries=5 abacws-sender
