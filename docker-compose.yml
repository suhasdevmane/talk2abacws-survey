services:
  mongo:
    image: mongo
    container_name: abacws-mongo
    restart: always
    volumes:
      - mongo-data:/data/db
    ports:
      - "27017:27017"
    networks:
      - ontobot-network

  api:
    build:
      context: api
      dockerfile: Dockerfile
    container_name: abacws-api
    hostname: apihost
    environment:
      - API_PORT=5000
      # MongoDB connection for survey service
      - MONGO_URL=mongodb://mongo:27017
      # JWT secret for authentication tokens
      - JWT_SECRET=change-this-jwt-secret-in-production-use-strong-random-string
      # Session secret (legacy)
      - SESSION_SECRET=change-this-secret-in-production
      - API_KEY=V3rySecur3Pas3word
    restart: always
    depends_on:
      - mongo
    ports:
      - "5000:5000"
    volumes:
      - ./api/src/api/data:/api/src/api/data
    networks:
      - ontobot-network
    healthcheck:
      test: ["CMD", "sh", "-lc", "wget -qO- http://localhost:5000/health | grep -q 'ok'"]
      interval: 30s
      timeout: 5s
      retries: 5

  visualiser:
    build:
      context: visualiser
      dockerfile: Dockerfile
    container_name: abacws-visualiser
    hostname: visualiserhost
    restart: always
    depends_on:
      - api
    ports:
      - "8090:80"
    environment:
      - WEB_PORT=80
      - API_HOST=api:5000
      # Optional: set to '1' to enable verbose 3D loader logging in browser console
      # - ABACWS_DEBUG=1
    networks:
      - ontobot-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.abacws-visualiser.loadbalancer.server.port=80"
      - "traefik.http.routers.abacws-visualiser.rule=Host(`visualiser.abacws.example.com`)"
      - "traefik.http.routers.abacws-visualiser.entrypoints=https"
      - "traefik.http.routers.abacws-visualiser.tls=true"
    healthcheck:
      test: ["CMD", "sh", "-lc", "wget -qO- http://localhost/health | grep -q 'ok'"]
      interval: 30s
      timeout: 10s
      retries: 5

  rasa-frontend:
    # image: devmanenvision/rasa-web-ui:bldg1-2025-10-29  # Option: pull prebuilt image from Docker Hub (comment out build: below)
    build:
      context: ./rasa-frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./rasa-frontend/:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - REACT_APP_API_URL=http://localhost:5000/api
      - REACT_APP_VISUALIZER_URL=http://localhost:8090
    depends_on:
      - api
    container_name: rasa-frontend-bldg1
    hostname: rasa-frontend-host-bldg1
    restart: unless-stopped
    command: npm start
    networks:
      - ontobot-network

  sender:
    build:
      context: .
      dockerfile: telemetry/Dockerfile
    container_name: abacws-sender
    restart: always
    depends_on:
      - api
      - visualiser
    environment:
      - API_BASE=http://api:5000/api
      - INTERVAL_SECONDS=10
      - API_HEALTH=http://api:5000/health
      - VIS_HEALTH=http://visualiser:80/health
    ports:
      - "8088:8088"
    networks:
      - ontobot-network
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:8088/health", "|", "grep", "ok"]
      interval: 30s
      timeout: 5s
      retries: 5

networks:
  ontobot-network:
    driver: bridge

volumes:
  mongo-data: